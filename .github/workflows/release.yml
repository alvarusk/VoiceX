name: release

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_USER_EMAIL: ${{ secrets.SUPABASE_USER_EMAIL }}
      SUPABASE_USER_PASSWORD: ${{ secrets.SUPABASE_USER_PASSWORD }}
      R2_ACCOUNT_ID: "${{ secrets.R2_ACCOUNT_ID }}"
      R2_ACCESS_KEY: "${{ secrets.R2_ACCESS_KEY }}"
      R2_SECRET_KEY: "${{ secrets.R2_SECRET_KEY }}"
      R2_BUCKET: "${{ secrets.R2_BUCKET }}"
      R2_PUBLIC_BASE: "${{ secrets.R2_PUBLIC_BASE }}"
    steps:
      - uses: actions/checkout@v4
      - name: Resolve app version (Windows)
        shell: pwsh
        run: |
          $pubspec = Get-Content pubspec.yaml -Raw
          if ($pubspec -notmatch '(?m)^version:\s*([0-9]+\.[0-9]+\.[0-9]+)(?:\+([0-9]+))?\s*$') {
            throw "Missing or invalid version in pubspec.yaml"
          }
          $buildName = $matches[1]
          $buildNumber = if ($matches[2]) { [int]$matches[2] } else { 0 }
          $runNumber = if ($env:GITHUB_RUN_NUMBER) { [int]$env:GITHUB_RUN_NUMBER } else { 0 }
          if ($runNumber -gt $buildNumber) { $buildNumber = $runNumber }
          $storeBuildName = $buildName
          if ($runNumber -gt 0) {
            $parts = $buildName.Split('.')
            if ($parts.Length -eq 3) {
              $storeBuildName = "$($parts[0]).$($parts[1]).$runNumber"
            }
          }
          # MS Store requires Appx/Package revision to be 0 (4th segment).
          $msixVersion = "$storeBuildName.0"
          $pubspec = [regex]::Replace($pubspec, '(?m)^\s*msix_version:\s*.*$', "  msix_version: $msixVersion")
          Set-Content -Path pubspec.yaml -Value $pubspec -NoNewline
          Add-Content -Path $env:GITHUB_ENV -Value "APP_VERSION_NAME=$storeBuildName"
          Add-Content -Path $env:GITHUB_ENV -Value "APP_VERSION_CODE=$buildNumber"
          Add-Content -Path $env:GITHUB_ENV -Value "MSIX_VERSION=$msixVersion"
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Cache Pub (Windows)
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\AppData\Local\Pub\Cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Cache Gradle (Windows)
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Test
        run: flutter test
      - name: Decode signing certificate
        env:
          WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
        run: |
          if (-not $env:WINDOWS_PFX_BASE64) { throw "Missing WINDOWS_PFX_BASE64 secret" }
          New-Item -ItemType Directory -Force -Path windows/certs | Out-Null
          [IO.File]::WriteAllBytes("windows/certs/code_sign.pfx", [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
      - name: Build Windows MSIX
        env:
          WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        shell: pwsh
        run: |
          flutter build windows --release `
            --build-name $env:APP_VERSION_NAME `
            --build-number $env:APP_VERSION_CODE `
            --dart-define SUPABASE_URL=$env:SUPABASE_URL `
            --dart-define SUPABASE_ANON_KEY=$env:SUPABASE_ANON_KEY `
            --dart-define SUPABASE_USER_EMAIL=$env:SUPABASE_USER_EMAIL `
            --dart-define SUPABASE_USER_PASSWORD=$env:SUPABASE_USER_PASSWORD `
            --dart-define R2_ACCOUNT_ID=$env:R2_ACCOUNT_ID `
            --dart-define R2_ACCESS_KEY=$env:R2_ACCESS_KEY `
            --dart-define R2_SECRET_KEY=$env:R2_SECRET_KEY `
            --dart-define R2_BUCKET=$env:R2_BUCKET `
            --dart-define R2_PUBLIC_BASE=$env:R2_PUBLIC_BASE
          # Genera MSIX sin firmar (la Store re-firma)
          flutter pub run msix:create `
            --output-path build/msix `
            --build-windows false `
            --publisher "CN=CCDE0167-EDA3-4A6F-B196-577B92A14DEC" `
            --publisher-display-name "Kingdom M" `
            --display-name "VoiceX for TakoWorks" `
            --identity-name "KingdomM.VoiceXforTakoWorks" `
            --certificate-path windows/certs/code_sign.pfx `
            --certificate-password $env:WINDOWS_PFX_PASSWORD `
            --install-certificate false
      - name: Upload MSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix
          path: build/msix/**/*.msix
      - name: Install StoreBroker
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module StoreBroker -Force -Scope CurrentUser
      - name: Upload MSIX to Microsoft Store
        shell: pwsh
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          PARTNER_CENTER_SELLER_ID: ${{ secrets.PARTNER_CENTER_SELLER_ID }}
          STORE_PRODUCT_ID: ${{ secrets.STORE_PRODUCT_ID }}
        run: |
          $ErrorActionPreference = "Stop"
          Import-Module StoreBroker -Force
          if (-not $env:AZURE_TENANT_ID) { throw "Missing AZURE_TENANT_ID secret" }
          if (-not $env:AZURE_CLIENT_ID) { throw "Missing AZURE_CLIENT_ID secret" }
          if (-not $env:AZURE_CLIENT_SECRET) { throw "Missing AZURE_CLIENT_SECRET secret" }
          if (-not $env:PARTNER_CENTER_SELLER_ID) { throw "Missing PARTNER_CENTER_SELLER_ID secret" }
          if (-not $env:STORE_PRODUCT_ID) { throw "Missing STORE_PRODUCT_ID secret" }

          $msix = Get-ChildItem -Path build/msix -Recurse -Filter *.msix | Select-Object -First 1
          if (-not $msix) { throw "MSIX not found under build/msix" }

          $secureSecret = ConvertTo-SecureString $env:AZURE_CLIENT_SECRET -AsPlainText -Force
          $creds = New-Object System.Management.Automation.PSCredential(
            $env:AZURE_CLIENT_ID,
            $secureSecret
          )
          Set-StoreBrokerAuthentication -TenantId $env:AZURE_TENANT_ID -Credential $creds

          $sbRoot = Join-Path $env:RUNNER_TEMP "storebroker"
          New-Item -ItemType Directory -Force -Path $sbRoot | Out-Null
          $configPath = Join-Path $sbRoot "appconfig.json"
          $outPath = Join-Path $sbRoot "out"
          New-StoreBrokerConfigFile -Path $configPath -AppId $env:STORE_PRODUCT_ID
          New-SubmissionPackage `
            -ConfigPath $configPath `
            -OutPath $outPath `
            -OutName "submission" `
            -AppxPath $msix.FullName
          $submissionJson = Join-Path $outPath "submission.json"

          Update-ApplicationSubmission `
            -AppId $env:STORE_PRODUCT_ID `
            -SubmissionDataPath $submissionJson `
            -PackagePath $msix.FullName `
            -ReplacePackages `
            -TargetPublishMode Immediate `
            -Visibility Public `
            -UpdatePublishModeAndVisibility `
            -AutoCommit

  build-android:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_USER_EMAIL: ${{ secrets.SUPABASE_USER_EMAIL }}
      SUPABASE_USER_PASSWORD: ${{ secrets.SUPABASE_USER_PASSWORD }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
      R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_PUBLIC_BASE: ${{ secrets.R2_PUBLIC_BASE }}
    steps:
      - uses: actions/checkout@v4
      - name: Resolve app version (Linux)
        shell: bash
        run: |
          set -euo pipefail
          VERSION_LINE="$(grep -E '^version:' pubspec.yaml | head -n1 | awk '{print $2}')"
          if [ -z "$VERSION_LINE" ]; then
            echo "Missing version in pubspec.yaml"
            exit 1
          fi
          BUILD_NAME="${VERSION_LINE%%+*}"
          if [[ "$VERSION_LINE" == *"+"* ]]; then
            BUILD_NUMBER="${VERSION_LINE##*+}"
          else
            BUILD_NUMBER="0"
          fi
          if [ -n "${GITHUB_RUN_NUMBER:-}" ] && [ "$GITHUB_RUN_NUMBER" -gt "$BUILD_NUMBER" ]; then
            BUILD_NUMBER="$GITHUB_RUN_NUMBER"
          fi
          echo "APP_VERSION_NAME=$BUILD_NAME" >> "$GITHUB_ENV"
          echo "APP_VERSION_CODE=$BUILD_NUMBER" >> "$GITHUB_ENV"
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - name: Cache Pub (Linux)
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: Cache Gradle (Linux)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Test
        run: flutter test
      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then echo "Missing ANDROID_KEYSTORE_BASE64 secret"; exit 1; fi
          mkdir -p android/app/keystores
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/keystores/upload.jks
      - name: Create key.properties
        run: |
          cat <<'EOF' > android/key.properties
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=keystores/upload.jks
          EOF
      - name: Build APK release (deprecated; prefer AAB)
        run: >
          flutter build apk --release
          --build-name $APP_VERSION_NAME
          --build-number $APP_VERSION_CODE
          --target-platform android-arm64
          --dart-define SUPABASE_URL=$SUPABASE_URL
          --dart-define SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
          --dart-define SUPABASE_USER_EMAIL=$SUPABASE_USER_EMAIL
          --dart-define SUPABASE_USER_PASSWORD=$SUPABASE_USER_PASSWORD
          --dart-define R2_ACCOUNT_ID=$R2_ACCOUNT_ID
          --dart-define R2_ACCESS_KEY=$R2_ACCESS_KEY
          --dart-define R2_SECRET_KEY=$R2_SECRET_KEY
          --dart-define R2_BUCKET=$R2_BUCKET
          --dart-define R2_PUBLIC_BASE=$R2_PUBLIC_BASE
      - name: Build AAB release
        run: >
          flutter build appbundle --release
          --build-name $APP_VERSION_NAME
          --build-number $APP_VERSION_CODE
          --dart-define SUPABASE_URL=$SUPABASE_URL
          --dart-define SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
          --dart-define SUPABASE_USER_EMAIL=$SUPABASE_USER_EMAIL
          --dart-define SUPABASE_USER_PASSWORD=$SUPABASE_USER_PASSWORD
          --dart-define R2_ACCOUNT_ID=$R2_ACCOUNT_ID
          --dart-define R2_ACCESS_KEY=$R2_ACCESS_KEY
          --dart-define R2_SECRET_KEY=$R2_SECRET_KEY
          --dart-define R2_BUCKET=$R2_BUCKET
          --dart-define R2_PUBLIC_BASE=$R2_PUBLIC_BASE
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/*.apk
      - name: Install fastlane
        run: sudo gem install fastlane -N
      - name: Decode Play service account
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "$PLAY_SERVICE_ACCOUNT_JSON" ]; then echo "Missing PLAY_SERVICE_ACCOUNT_JSON secret"; exit 1; fi
          echo "$PLAY_SERVICE_ACCOUNT_JSON" | base64 -d > /tmp/play.json
      - name: Upload AAB to Play (internal track)
        env:
          PLAY_PACKAGE_NAME: ${{ secrets.PLAY_PACKAGE_NAME }}
        run: |
          if [ -z "$PLAY_PACKAGE_NAME" ]; then echo "Missing PLAY_PACKAGE_NAME secret"; exit 1; fi
          fastlane supply \
            --aab build/app/outputs/bundle/release/app-release.aab \
            --json_key /tmp/play.json \
            --package_name "$PLAY_PACKAGE_NAME" \
            --track internal \
            --skip_upload_apk true \
            --skip_upload_metadata true \
            --skip_upload_images true \
            --skip_upload_screenshots true
